# ttron-ttr20-time

Решение тестового задания **ООО Мависмарт**

![GitHub](https://img.shields.io/github/license/dimbo1324/ttron-ttr20-time)
![Go Version](https://img.shields.io/badge/Go-1.25-blue)
![Platform](https://img.shields.io/badge/Platform-Windows%2011-green)

Этот проект - простая программа на языке Go (с черновым вариантом на Python), которая решает тестовое задание: каждые 5 секунд считывать время и дату с устройства ТЭКОН-20 (модель ТТР20) по протоколу FT1.2 и выводить их в лог. Проект включает клиента (для опроса) и эмулятор сервера (для симуляции устройства, чтобы тестировать без реального оборудования).

Проект разработан на Windows 11 в редакторе VS Code.

## Что это за проект и зачем он нужен?

Тестовое задание (см. файл `task/Тестовое задание ядро.docx`) требует написать программу, которая:

- Подключается к устройству ТЭКОН-20 (ТТР20) по сети (TCP).
- Каждые 5 секунд (например, на 0-й, 5-й, 10-й секунде минуты) отправляет запрос на чтение времени и даты.
- Получает ответ, парсит его и записывает в лог (файл или консоль).
- Работает по протоколу FT1.2 (описан в руководстве `docs/files/ttp20.pdf` - это руководство по программе "Телепорт" для обмена с устройствами ТЭКОН).

Поскольку реального устройства у меня нет под рукой, я добавил **эмулятор** (симулятор устройства), который отвечает на запросы, как будто это настоящий ТТР20. Это позволяет тестировать программу без оборудования.

Проект разделён на:

- **Клиент** (go_sln/client): Отправляет запросы и логирует время.
- **Эмулятор** (go_sln/server): Симулирует устройство, возвращает текущее время сервера.
- **Python-версия** (py_sln): Черновой вариант на Python (не основной, но рабочий для сравнения).

## Как это работает?

1. **Протокол FT1.2** (просто объяснено):
   - Обмен происходит по TCP (как простое сетевое соединение).
   - Запрос - это "пакет" байтов в специальном формате (фрейм): начинается с 0x68, содержит адрес устройства, команду (0x01 для чтения времени) и контрольную сумму (sum или crc16).
   - Ответ - похожий фрейм с временем в формате "YYYY-MM-DD HH:MM:SS".
   - Клиент отправляет запрос каждые 5 секунд, парсит ответ и пишет в лог, например: "device time: 2025-08-28T14:00:00Z".

2. **Клиент**:
   - Подключается к серверу (или эмулятору).
   - Каждую секунду проверяет время: если секунда кратна 5, отправляет запрос.
   - Если ошибка (таймаут, плохой ответ), пытается переподключиться (до 2 попыток по умолчанию).
   - Логирует всё: запросы, ответы, ошибки.

3. **Эмулятор**:
   - Слушает подключения на указанном порту.
   - Получает запрос, проверяет его, возвращает текущее время.
   - Можно добавить "шум": задержку ответа, плохую контрольную сумму или фрагментированный ответ (для тестирования ошибок).
   - Эмулятор совместим с ПО "Телепорт": вы можете подключиться к эмулятору через "Телепорт" (как к реальному устройству). В режиме "Перевести в режим обмена" в логах "Телепорт" (папка `Kreit\LogsTTP20` в AppData пользователя, например, `C:\Users\<ваше_имя>\AppData\Roaming\Kreit\LogsTTP20`) увидите записи об обмене. Успешное подключение: "12:30:52:326 : Инициализация соединения UDP/TCP". Неуспешное: "12:25:20:462 : 127.0.0.1 (9000)   Ошибка установки соединения по TCP". Это полезно для отладки протокола без реального оборудования.

4. **Взаимодействие**:
   - Запустите эмулятор на одном терминале.
   - Запустите клиента на другом - он будет опрашивать эмулятор.
   - В реальности вместо эмулятора подключитесь к настоящему ТТР20 (настройки как в программе "Телепорт", см. скриншот ниже). Или используйте "Телепорт" для подключения к эмулятору и проверки логов.

## Требования для запуска

- **Go 1.25** (скачайте с [официального сайта](https://go.dev/dl/)).
- **Windows 11** (тестировалось здесь, но должно работать на Linux/Mac с минимальными изменениями).
- Нет внешних зависимостей - чистый Go.
- Для Python-версии: Python 3.x.

## Сборка и запуск

### 1. Клонируйте репозиторий

```bash
git clone https://github.com/dimbo1324/ttron-ttr20-time.git
cd ttron-ttr20-time
```

### 2. Запуск Go-версии (основная)

#### Эмулятор (сервер)

Перейдите в `go_sln/server`:

```bash
cd go_sln/server
go build -o serv.exe  # Сборка (для Windows)
.\serv.exe -host 127.0.0.1 -port 9000 -crc sum -delay 100 -badcrc 0.2 -fragment 0.1 -adapter 1 -log emulator.log
```

- **Параметры**:
  - `-host`: IP для прослушки (по умолчанию 127.0.0.1).
  - `-port`: Порт (9000).
  - `-crc`: Режим контрольной суммы (sum или crc16).
  - `-delay`: Задержка ответа в мс (0 - без задержки).
  - `-badcrc`: Вероятность плохой суммы (0.0 - 1.0).
  - `-fragment`: Вероятность разбиения ответа (0.0 - 1.0).
  - `-adapter`: Адрес адаптера (1).
  - `-log`: Файл лога (пусто - в консоль).
  - `-readtimeout`: Таймаут чтения (300 сек).

![Сборка и запуск эмулятора](docs/images/build_and_run_server_ps.jpg)

#### Клиент

Перейдите в `go_sln/client`:

```bash
cd go_sln/client
go build -o cl.exe  # Сборка (для Windows)
.\cl.exe -host 127.0.0.1 -port 9000 -crc sum -adapter 1 -timeout 1200 -retries 2 -pollstep 1 -log client.log
```

- **Параметры**:
  - `-host` и `-port`: Адрес сервера/устройства.
  - `-crc`: Режим суммы (sum или crc16).
  - `-adapter`: Адрес адаптера (1).
  - `-timeout`: Таймаут ответа в мс (1000).
  - `-retries`: Повторов при ошибке (2).
  - `-pollstep`: Шаг проверки времени в сек (1).
  - `-log`: Файл лога.

![Сборка и запуск клиента](docs/images/build_and_run_client_ps.jpg)

### 3. Подключение к реальному устройству

В программе "Телепорт" настройте подключение (см. руководство `docs/files/ttp20.pdf`). Пример настроек через Ethernet K-104:

![Настройки подключения в Телепорт](docs/images/con_props.jpg)

В клиенте укажите реальный IP и порт устройства вместо локального. Для тестирования подключите "Телепорт" к эмулятору - логи обмена появятся в папке `Kreit\LogsTTP20` (обычно в AppData\Roaming\Kreit\LogsTTP20). Успех: "Инициализация соединения UDP/TCP". Ошибка: "Ошибка установки соединения по TCP".

### 4. Python-версия (запасная)

- Клиент: `py_sln/app/tt_time_client.py` (запустите с параметрами как в Go).
- Эмулятор: `py_sln/emulator/emulator.py`.
Это черновик, но работает аналогично. Запускайте через `python tt_time_client.py [параметры]`.

## Структура проекта

- **docs/**: Документы и изображения.
  - files/ttp20.pdf: Руководство по "Телепорт".
  - images/: Скриншоты.
- **go_sln/**: Основная реализация на Go.
  - client/: Клиент для опроса.
  - server/: Эмулятор устройства.
- **py_sln/**: Черновик на Python.
- **task/**: Тестовое задание.
- **.gitignore**: Игнорируемые файлы (exe, логи).
- **LICENSE**: Лицензия MIT.

## Лицензия

MIT License

Copyright (c) 2025 Dmitry Prikhodko
